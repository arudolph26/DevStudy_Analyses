---
title: "204 questions re dev study"
output: 
html_document:
toc: true
toc_depts: 2
---

```{r setup_env, echo=FALSE, message=FALSE, warning=FALSE}
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/code/workspace_scripts/DevStudy_workspace.R')
```

1. Do people 'explore' the first five trials where the reward probabilities for each machine are presented?

They explore less when they encounter a loss early on. In the high var pos EV machine they get 4 (small) losses in a row; in the low var negative EV machine they get a moderate loss in the first trial.

```{r}
machine_game_data_clean %>% 
  group_by(Sub_id, facet_labels) %>%
  slice(1:5) %>%
  summarise(num_explored = sum(ifelse(Response == "play", 1,0))) %>%
  do(assign.age.info(.)) %>%
  ungroup() %>%
  group_by(age_group, facet_labels) %>%
  summarise(mean_num_explored = mean(num_explored),
            sem_num_explored = sem(num_explored)) %>%
  ggplot(aes(facet_labels, mean_num_explored, fill = age_group))+
  geom_bar(stat="identity",position = position_dodge(0.9))+
  geom_errorbar(aes(ymax = mean_num_explored+sem_num_explored, ymin = mean_num_explored-sem_num_explored), position = position_dodge(width = 0.9), width=0.25)+
  labs(fill = 'Age group')
```

2. Is the difference in performance between the age groups uniform across time?

No. As expected from the [previous notebook](http://zenkavi.github.io/DevStudy_Analyses/output/reports/ExploratoryDVs.nb.html) the difference exists only for the high var negative EV machine and grows over time due to improvement in adult performance and lack of change in kid performance.

```{r}
machine_game_data_clean %>%
  group_by(facet_labels, Sub_id) %>%
  mutate(relative_trial_num = 1:n()) %>%
  ungroup() %>%
  group_by(relative_trial_num, facet_labels, age_group) %>%
  summarise(mean_correct = mean(correct1_incorrect0),
            sem_correct = sem(correct1_incorrect0)) %>%
  filter(relative_trial_num<46) %>%
  ggplot(aes(relative_trial_num, mean_correct, col = age_group))+
  geom_point(alpha = 0.5)+
  geom_line()+
  geom_errorbar(aes(ymax = mean_correct+sem_correct, ymin = mean_correct-sem_correct), alpha = 0.25)+
  facet_wrap(~facet_labels)+
  theme_bw()+
  labs(col = 'Age group')+
  ylab("Proportion of participants that respond correctly")+
  xlab("Relative trial number")
```

Why are they not exploring the second machine in the first trial?

Because they are confused. It's the first trial.

```{r}
machine_game_data_clean %>%
  # arrange(Trial_number)
  group_by(facet_labels, Sub_id) %>%
  mutate(relative_trial_num = 1:n()) %>%
  # filter(facet_labels == '+5,-495') %>%
  arrange(relative_trial_num)
```

How about trials since last played?

Can we think of this as a 'memory effect'? The more trials since the last time you have played, the more interference? There doesn't seem to be an age difference in this.

```{r}
# install.packages('zoo')
library(zoo)

machine_game_data_clean %>%
  filter(facet_labels == '+5,-495') %>%
  group_by(Sub_id) %>%
  mutate(relative_trial_number = 1:n(),
         played_trial_number = ifelse(Response == "play", Trial_number, NA)) %>%
  mutate(played_trial_number = na.locf(played_trial_number, na.rm=F)) %>%
  filter(relative_trial_number > 1) %>%
  mutate(trials_since_last_played = Trial_number - lag(played_trial_number)) %>%
  group_by(trials_since_last_played, age_group) %>%
  summarise(mean_played = mean(correct1_incorrect0, na.rm = T),
            sem_played = sem(correct1_incorrect0)) %>%
  ggplot(aes(trials_since_last_played, mean_played, col = factor(age_group, levels=c('kid', 'teen', 'adult'))))+
  geom_smooth(alpha=0.5)+
  theme_bw()+
  labs(col='Age group')
  
```

## Average number of trials to play again post outcome

If subjects are sensitive to losses and learning something about the machines in a way that overweights their most recent experience with the machine (e.g. a simple prediction error model that had been used for this data before) one sanity check is to compare how many trials it takes subjects to play a machine again after a loss versus a gain. Presumably the former would be higher than the latter, that is one would hesitate to play a machine again after a loss but more likely to play it after a gain.

```{r}
count.postoutcome.trials <- function(subject_data){
  
  loss_trials = which(subject_data$Points_earned<0)
  
  gain_trials = which(subject_data$Points_earned>0)
  
  play_trials= which(subject_data$Response == "play")
  
  post_loss_trials = play_trials[which(play_trials %in% loss_trials)+1]
  
  post_gain_trials = play_trials[which(play_trials %in% gain_trials)+1]
  
  num_trials_post_loss = post_loss_trials - loss_trials
  
  num_trials_post_gain = post_gain_trials - gain_trials
  
  if(length(num_trials_post_gain)>length(num_trials_post_loss)){
    num_trials_post_loss <- c(num_trials_post_loss, rep(NA, length(num_trials_post_gain) - length(num_trials_post_loss)))
  }
  else if(length(num_trials_post_gain)<length(num_trials_post_loss)){
    num_trials_post_gain <- c(num_trials_post_gain, rep(NA, length(num_trials_post_loss) - length(num_trials_post_gain)))
  }
  
  return(data.frame(num_trials_post_loss = num_trials_post_loss, num_trials_post_gain = num_trials_post_gain))
}
```

This graph shows the average number of trials it takes a subject to play a given machine after experiencing a loss or a gain.   

For everyone and for every machine the average number of trials it takes a subject to play following a loss is higher than the average number of trials it take them to play following a gain. This suggests that subjects are responding to outcomes in a way overweights their most recent experience with the machine.   

I think this serves as a (weak) sanity check for our intuitions modeling this data using simple prediction error models that are updated after each trial.

One thought that is not necessarily immediately pertinent but that I puzzled over is how this graph would have looked like if subjects were taking all their experiences with the machine in to account (instead of overweighing their most recent experience). I have a vague intuition that in that case the difference in responding between the experiences (gain/loss) would be 0. That is, if one takes in to account all their experiences then they would distinguish between the positive and negative EV machines and either always play for positive EV machines or never play for negative EV machines regardless of the observed outcome. Relatedly then, this difference in response patterns depending on the observed outcome could be due to at least two reasons: memory or loss aversion. Or perhaps stronger memories for losses. I'm not sure where I'm going with this but perhaps there is something interesting to look at in the hippocampal activity following losses versus gains.

```{r}
tmp = machine_game_data_clean %>%
  group_by(Sub_id, facet_labels) %>%
  do(count.postoutcome.trials(.))  %>%
  do(assign.age.info(.)) %>%
  ungroup() %>%
  select(facet_labels, age_group, num_trials_post_loss, num_trials_post_gain, Sub_id) %>%
  gather(key, value, -facet_labels, -age_group, -Sub_id) %>%
  mutate(key = gsub("num_trials_post_", "", key)) 

tmp %>%
  group_by(facet_labels, age_group, key) %>%
  summarise(mean_post = mean(value, na.rm=T),
            sem_post = sem(value)) %>%
  ggplot(aes(age_group, mean_post, shape=key, col=age_group))+
  geom_point()+
  geom_errorbar(aes(ymin = mean_post-sem_post, ymax = mean_post+sem_post), width=0)+
  facet_wrap(~facet_labels)+
  xlab("Number of trials until next play")+
  theme(legend.title = element_blank())+
  guides(color=FALSE)
```

Reflecting the global behavior in proportion of playing in each condition adults take longer to play after large losses in the high variance negative EV condition compared to kids while kids are less sensitive to the magnitude of loss.

```{r}
summary(lm(value~age_group*facet_labels,tmp %>%filter(key=="loss")))
```

## How many people experience multiple losses (for each machine)

```{r eval=FALSE}
loss.per.machine <- function(subject_data){
  
  Sub_id = unique(subject_data$Sub_id)
  
  loss_trials = which(subject_data$Points_earned<0)
  
  loss_per_machine = as.data.frame(table(subject_data$Trial_type[loss_trials]))
  
  out <- data.frame(Sub_id = rep(Sub_id, nrow(loss_per_machine)), machine = loss_per_machine$Var1, num_loss = loss_per_machine$Freq)
  
  return(out)
}

loss_per_machine = machine_game_data_clean %>%
  group_by(Sub_id) %>%
  do(loss.per.machine(.)) %>%
  do(assign.age.info(.)) %>%
  mutate(facet_labels = ifelse(machine == 1, "+5,-495", ifelse(machine == 2, "-5,+495", ifelse(machine == 3, "-10,+100", ifelse(machine == 4, "+10,-100", NA)))))
```

```{r}
loss_per_machine %>%
  ggplot(aes(num_loss, fill=age_group))+
  geom_histogram(position = "identity", alpha=0.5)+
  facet_wrap(~facet_labels)+
  theme(legend.position = "bottom",
        legend.title=element_blank())
```

#Which machine do people experience a single loss most frequently?

```{r}
with(loss_per_machine[loss_per_machine$num_loss == 1,], table(facet_labels))
```

## Cross-talk between machines

Are subjects less likely to play overall after a loss or only less likely to play that machine after a loss for that machine?

```{r}
mean.postloss.play.prob <- function(subject_data){
  
  Sub_id = unique(subject_data$Sub_id)
  
  loss_trials = which(subject_data$Points_earned<0)
  
  mean_post_loss_prob <- mean(ifelse(subject_data$Response[loss_trials+1] == "play", 1, 0), na.rm=T)
  
  return(data.frame(mean_post_loss_prob=mean_post_loss_prob))
}
```

Probability of playing following a loss depends on machine type. Looking at all trials masks this difference. Subjects seem to learn machine specifically and cross-talk isn't evident here.

```{r}
tmp = machine_game_data_clean %>%
  group_by(Sub_id) %>%
  do(mean.postloss.play.prob(.)) %>%
  mutate(facet_labels = "all_trials")

machine_game_data_clean %>%
  group_by(Sub_id, facet_labels) %>%
  do(mean.postloss.play.prob(.)) %>%
  rbind(tmp) %>%
  do(assign.age.info(.)) %>%
  group_by(age_group, facet_labels) %>%
  summarise(mp = mean(mean_post_loss_prob,na.rm=T),
            sp = sem(mean_post_loss_prob)) %>%
  ggplot(aes(facet_labels, mp, fill=age_group))+
  geom_bar(stat="identity",position=position_dodge())+
  geom_errorbar(width=0, aes(ymin = mp-sp, ymax = mp+sp), position = position_dodge(width=0.9))+
  xlab("")+
  ylab("Post loss play probability")+
  theme(legend.title = element_blank())
```
