---
title: "ROI analyses"
output:
github_document:
toc: yes
toc_float: yes
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
fig_path = '/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/output/figures/'

from_gh=FALSE
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/code/helper_functions/ggplot_colors.R')
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/code/helper_functions/sem.R')
library(lme4)
library(broom)
learner_info = read.csv("~/Dropbox/PoldrackLab/DevStudy_ServerScripts/nistats/level_3/learner_info.csv")
learner_info = learner_info %>%
  select(-non_learner) %>%
  rename(sub_id = Sub_id) %>%
  mutate(sub_id = as.numeric(as.character(gsub("sub-", "", sub_id))))

```

```{r}
all_roi_pe_zvals = read.csv('~/Dropbox/PoldrackLab/DevStudy_Analyses/input/rois/all_roi_pe_zvals.csv')
all_roi_pe_zvals
```

## PE-related activity

- We did not find any difference that survived whole-brain correction between learners and non-learners in response to RPE related activity.   
- Schoenberg et al. (2007) groups their participants similarly based on task performance and does a group comparison in an ROI (VStr).  They find higher PE related activity for learners compared to non-learners ('engagement of RL signals').  
- Inspired by this we compared PE related activity in several ROIs. We have two PE related regressors for high and low variance stimuli.  
We do not find any region where PE related activity is higher for learners compared to non-learners.   
- Overall non-learners show larger increases and decreases compared to learners.  
- The group difference between learners and non-learners in this dataset lies in the difference in response to HPE vs LPE. Learners generally do not show change in activity in response to HPE but they do for LPE whereas non-learners activity changes similarly regardless of the PE type.  
- So we do find different response PE-related response profiles in these ROIs for the two learner groups but especially given that neither of these regressors showed any activity that survived whole brain correction to begin with these are difficult to interpret.

Looking at the full distribution

```{r}
all_roi_pe_zvals %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner=ifelse(learner == 1, "Learner", "Non-learner"),
         roi = factor(roi, levels = c("l_vstr", "r_vstr", "vmpfc", "l_ains", "r_ains", "pcc", "acc", "pre_sma", "r_dstr"))) %>%
  group_by(sub_num, learner, roi, regressor) %>%
  summarise(max_zval = max(value),
            min_zval = min(value)) %>%
  mutate(max_zval = ifelse(abs(max_zval)>abs(min_zval), max_zval, min_zval)) %>%
  filter(roi %in% c("vmpfc", "l_ains", "pcc", "pre_sma")== FALSE) %>%
  ggplot(aes(roi, max_zval, col=learner))+
  geom_hline(aes(yintercept=0),linetype="dashed")+
  facet_grid(.~regressor)+
  xlab("")+
  ylab("Peak Z")+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())
```

Versus looking at the summary

```{r}
all_roi_pe_zvals %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner=ifelse(learner == 1, "Learner", "Non-learner"),
         roi = factor(roi, levels = c("l_vstr", "r_vstr", "vmpfc", "l_ains", "r_ains", "pcc", "acc", "pre_sma", "r_dstr"))) %>%
  group_by(sub_num, learner, roi, regressor) %>%
  summarise(max_zval = max(value),
            min_zval = min(value)) %>%
  mutate(max_zval = ifelse(abs(max_zval)>abs(min_zval), max_zval, min_zval)) %>%
  ungroup()%>%
  group_by(learner, roi, regressor) %>%
  summarise(mean_zval = mean(max_zval),
            sem_zval = sem(max_zval)) %>%
  filter(roi %in% c("vmpfc", "l_ains", "pcc", "pre_sma")== FALSE) %>%
  ggplot(aes(roi, mean_zval, col=learner))+
  geom_point(position=position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin=mean_zval-sem_zval, ymax=mean_zval+sem_zval), position = position_dodge(width=0.9), width=0.25)+
  geom_hline(aes(yintercept=0),linetype="dashed")+
  facet_grid(.~regressor)+
  xlab("")+
  ylab("Mean peak Z")+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())

ggsave("PE_Str_ROIs.jpeg", device = "jpeg", path = fig_path, width = 5, height = 3, units = "in", dpi = 450)
```

## Brain-behavior correlation

Brain - parameter correlations? (Remember the question of interest is: what is the best/a good marker of self-regulation)

```{r}
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/code/workspace_scripts/rl_fits_data.R')
```

Is average PE related activity in any of the ROIs associated with the any model parameters?

```{r}
ave_roi_pe_zvals = all_roi_pe_zvals %>%
  # filter(abs(value)<10)%>%
  group_by(roi, sub_num) %>%
  summarise(mean_z = mean(value))
```

```{r}
exp_exp_models = c("Fit_alpha-beta-exp_neg-exp_pos-lossave_Fix_",
                   "Fit_alpha-beta-exp_neg-exp_pos_Fix_lossave_",
                   "Fit_alpha_neg-alpha_pos-beta-exp_neg-exp_pos_Fix_lossave_", 
                   "Fit_alpha_neg-alpha_pos-beta-exp_neg-exp_pos-lossave_Fix_",
                   "Fit_alpha_neg-alpha_pos-beta-exp-lossave_Fix_", 
                   "Fit_alpha_neg-alpha_pos-beta-exp_Fix_lossave_")

roi_par_cors = ave_roi_pe_zvals %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              filter(model %in% exp_exp_models)%>%
              select(sub_id, learner, model, contains("xopt")) %>%
              select_if(~sum(!is.na(.)) > 0), by="sub_id") %>%
  filter(xopt_beta<3) %>%
  gather(key, value, -roi, -sub_id, -learner, -model, -mean_b)%>%
  group_by(model, roi, key) %>%
  summarise(roi_cor = cor(mean_b, value)) %>%
  mutate(t_val = (roi_cor*sqrt(72-2))/sqrt(1-roi_cor^2),
         p_val = 1-pt(t_val, 70)) %>%
  drop_na()%>%
  mutate(p_val_adj = p.adjust(p_val), method="fdr") %>%
  # filter(p_val_adj<0.05) %>%
  arrange(-abs(roi_cor)) 

roi_par_cors

fc_par_cors = all_cors %>%
  group_by(sub_num, roi)%>%
  summarise(mean_cor= mean(cor)) %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              filter(model %in% exp_exp_models)%>%
              select(sub_id, learner, model, contains("xopt")) %>%
              select_if(~sum(!is.na(.)) > 0), by="sub_id") %>%
  filter(xopt_beta<3) %>%
  gather(key, value, -roi, -sub_id, -learner, -model, -mean_cor)%>%
  group_by(model, roi, key) %>%
  drop_na()%>%
  do(tidy(lm(mean_cor ~ value*learner, data = .))) %>%
  filter(term != "(Intercept)") %>%
  filter(p.value<0.05) 

fc_par_cors
```

- Looking only at exp_exp models since GLM's were fit on average PEs from these models  
- The parameter that significantly correlates with brain data the most frequently is beta  
- *Main point:* The behavioral measure does not match the neural summary measure in between subject variability. This results in spurious correlations driven by outliers that can be used to tell different narratives. (e.g. choosing the last column vs choosing the most complicated model)  

When looking for individual difference measures finding a "relationship" should not suffice. We should look for measures with comparable variance structures.

```{r warning=FALSE, message=FALSE}
ave_roi_pe_zvals %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              filter(model %in% names(table(roi_par_cors$model[roi_par_cors$key == "xopt_beta"]))) %>%
              select(sub_id, learner, xopt_beta, model), by="sub_id") %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner"),
         col_col = ifelse(paste0(roi,model) %in% paste0(roi_par_cors$roi, roi_par_cors$model), "Sig.", "Not Sig.")) %>%
  filter(xopt_beta <3) %>%
  left_join(num_pars_df %>%
              mutate(model = gsub("LearningParams_", "", model)) %>%
              filter(model %in% exp_exp_models) %>%
              select(model, x_axis), by = "model") %>%
  filter(roi %in% c("l_vstr", "r_vstr", "r_dstr")) %>%
  # ggplot(aes(scale(xopt_beta), scale(mean_b)))+
  ggplot(aes(xopt_beta, mean_b))+
  geom_point(aes(col=learner))+
  geom_smooth(method="lm", alpha=0.5, aes(col=col_col))+
  facet_grid(roi~x_axis, labeller = label_wrap_gen(10))+
  theme(panel.grid = element_blank(),
        legend.title = element_blank())+
  scale_color_manual(values=c(cbbPalette[1], cbbPalette[2],"black","red"))+
  xlab("Inverse temperature (\u03b2)")+
  ylab("Mean b from ROI")+
  guides(color=guide_legend(ncol=2))

ggsave("Brain-behavior_ROIs.jpeg", device = "jpeg", path = fig_path, width = 5, height = 4, units = "in", dpi = 450)  
```

## Functional connectivity

Data from different ROIs can be analyzed with respect to each other instead of in isolation as well.  

In this case, for example, we examined whether the time series in an apriori l_vstr seed was similar to any other voxels time series.  
**(SHOULD THIS BE ONE TIME STEP AHEAD?)**

Prior literature has examples suggesting that such connectivity patterns might differ depending on performance (van den Bos, et al.).  

If so, we could expect differentces between the learner and non-learner groups.  

We do not find any voxels where the time series correlates significantly/above 0 on average for all subjects *This doesn't sound right when looking at the boxplots of correlations. Except for pre-sma the average correlations between an ROI and l-vstr seed are always >0*
**(CORRELATION BETWEEN TIME SERIES; WHAT WOULD BE THEIR T/Z/P-VALUES? You know the number of time points and can calculate t values based on that)**

This is the same for both learner groups as well. **(DON'T THINK I CHECKED FOR THIS STATISTICALLY. EXTRACT AVERAGE CORRELATION VALUES FOR LEARNERS AND NON-LEARNERS FROM WHOLE BRAIN AND COMPARE TO EACH OTHER?)**


```{r}
input_path = "~/Dropbox/PoldrackLab/DevStudy_Analyses/input/"
all_cors = read.csv(paste0(input_path, 'func_cor/all_l_vstr_cors.csv'))
all_cors
```

```{r}
all_cors %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner")) %>%
  # group_by(learner, roi) %>%
  group_by(sub_num,learner, roi) %>%
  summarise(mean_cor = mean(cor),
            sem_cor = sem(cor)) %>%
  ggplot(aes(roi, mean_cor, fill=learner))+
  geom_boxplot()+
  # geom_bar(stat="identity", position = position_dodge(width = 0.9))+
  # geom_errorbar(aes(ymin= mean_cor-sem_cor, ymax=mean_cor+sem_cor), position = position_dodge(width = 0.9), width=0.25)+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())+
  xlab("")+
  ylab("Mean Correlation with L-vStr seed")

ggsave("FC_lvstr_mean.jpeg", device = "jpeg", path = fig_path, width = 5, height = 4, units = "in", dpi = 450)    
```

None of the interactions is significant.

```{r}
tmp = all_cors %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner")) %>%
  group_by(sub_num, learner, roi) %>%
  summarise(mean_cor = mean(cor))

summary(lm(mean_cor ~ roi*learner, tmp))
```

Is the change in connectivity different between the learner groups?

```{r}
all_cors %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner")) %>%
  group_by(sub_num,learner, roi, run_num) %>%
  summarise(mean_cor = mean(cor)) %>%
  spread(run_num, mean_cor) %>%
  mutate(ch_1_to_6 = `1`-`6`) %>%
  ggplot(aes(roi, ch_1_to_6, fill=learner))+
  geom_boxplot()+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())+
  xlab("")+
  ylab("Change in Mean Correlation \nwith L-vStr seed")
```

Connectivity data seems to vary more between participants. Is it suitable to be related to behavioral parameter estimates?

```{r}
fc_par_cors = all_cors %>%
  group_by(sub_num, roi)%>%
  summarise(mean_cor= mean(cor)) %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              filter(model %in% exp_exp_models)%>%
              select(sub_id, learner, model, contains("xopt")) %>%
              select_if(~sum(!is.na(.)) > 0), by="sub_id") %>%
  filter(xopt_beta<3) %>%
  gather(key, value, -roi, -sub_id, -learner, -model, -mean_cor)%>%
  group_by(model, roi, key) %>%
  drop_na()%>%
  do(tidy(lm(mean_cor ~ value*learner, data = .))) %>%
  filter(term != "(Intercept)") %>%
  filter(p.value<0.05) 

fc_par_cors

```

```{r warning=FALSE, message=FALSE}
tmp = all_cors %>%
  group_by(sub_num, roi)%>%
  summarise(mean_cor= mean(cor)) %>%
  rename(sub_id = sub_num)%>% 
  left_join(best_sub_pars %>%
              filter(model %in% names(table(fc_par_cors$model))) %>%
              select(sub_id, learner, contains("xopt"), model), by="sub_id") %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner")) %>%
  filter(xopt_beta <3) %>%
  left_join(num_pars_df %>%
              mutate(model = gsub("LearningParams_", "", model)) %>%
              filter(model %in% exp_exp_models) %>%
              select(model, x_axis), by = "model") %>%
  gather(key, value, -sub_id, -roi, -mean_cor, -learner,-model, -x_axis)

tmp$col_cor = NA

#this works but takes a while
# for(i in 1:nrow(tmp)){
#   a = with(tmp[i,], paste0(roi,model,key))
#   for(j in 1:nrow(fc_par_cors)){
#     b = with(fc_par_cors[j,], paste0(roi,model,key))
#     if(a == b){
#       tmp$col_cor[i] = fc_par_cors$term[j]
#     }
#   }
# }
```  

```{r}
tmp %>%
  filter(roi %in% c("l_ains", "pcc", "r_ains", "r_vstr", "vmpfc")) %>%
  filter(key == "xopt_alpha_neg")%>%
  filter(model %in% c("Fit_alpha-beta-exp_neg-exp_pos-lossave_Fix_","Fit_alpha-beta-exp_neg-exp_pos_Fix_lossave_") == FALSE) %>%
  ggplot(aes(value, mean_cor))+
  geom_point(aes(col=learner), alpha=0.5)+
  geom_smooth(method="lm", aes(col=learner, linetype=col_cor), se=FALSE)+
  facet_grid(roi~x_axis, labeller = label_wrap_gen(10))+
  theme(panel.grid = element_blank(),
        legend.title = element_blank())+
  ylab("Mean FC with l-Vstr seed")+
  xlab("\u03b1_loss")
```

The story that the brain behavior correlation tells you is about different cognitive processes than those that relate to behavior.

```{r}
tmp %>%
  filter(roi %in% c("l_ains", "pcc", "r_ains", "r_vstr", "vmpfc")) %>%
  filter(key %in%  c("xopt_alpha_neg","xopt_alpha_pos","xopt_beta", "xopt_exp"))%>%
  filter(model %in% c("Fit_alpha_neg-alpha_pos-beta-exp_Fix_lossave_")) %>%
  ggplot(aes(value, mean_cor))+
  geom_point(aes(col=learner), alpha=0.5)+
  geom_smooth(method="lm", aes(col=learner, linetype=col_cor), se=FALSE)+
  facet_grid(roi~key, labeller = label_wrap_gen(10))+
  theme(panel.grid = element_blank(),
        legend.title = element_blank())+
  ylab("Mean FC with l-Vstr seed")
```