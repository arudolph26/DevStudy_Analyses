---
title: "ROI analyses"
output:
github_document:
toc: yes
toc_float: yes
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
fig_path = '/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/output/figures/'

from_gh=FALSE
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/code/helper_functions/ggplot_colors.R')
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/SRO_Retest_Analyses/code/helper_functions/sem.R')
library(lme4)
learner_info = read.csv("~/Dropbox/PoldrackLab/DevStudy_ServerScripts/nistats/level_3/learner_info.csv")
learner_info = learner_info %>%
select(-non_learner) %>%
rename(sub_id = Sub_id) %>%
mutate(sub_id = as.numeric(as.character(gsub("sub-", "", sub_id))))
```

```{r}
all_roi_pe_betas = read.csv('~/Dropbox/PoldrackLab/DevStudy_Analyses/input/rois/all_roi_pe_betas.csv')
all_roi_m1_betas = read.csv('~/Dropbox/PoldrackLab/DevStudy_Analyses/input/rois/all_roi_m1_betas.csv')
```

## PE-related activity

We did not find any difference that survived whole-brain correction between learners and non-learners.   
Schoenberg et al. (2007) groups their participants similarly based on task performance and does a group comparison in an ROI (VStr).  They find higher PE related activity for learners compared to non-learners ('engagement of RL signals').
Inspired by this we compared PE related activity in several ROIs. We have two PE related regressors for high and low variance stimuli.  
We do not find any region where PE related activity is higher for learners compared to non-learners.   
Overall non-learners show larger increases and decreases compared to learners.  
The group difference between learners and non-learners in this dataset lies in the difference in response to HPE vs LPE. Learners generally do not show change in activity in response to HPE but they do for LPE whereas non-learners activity changes similarly regardless of the PE type.  
So we do find different response PE-related response profiles in these ROIs for the two learner groups but especially given that neither of these regressors showed any activity that survived whole brain correction to begin with these are difficult to interpret.

```{r}
all_roi_pe_betas %>%
 filter(abs(value) < 10) %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner=ifelse(learner == 1, "Learner", "Non-learner"),
         roi = factor(roi, levels = c("l_vstr", "r_vstr", "vmpfc", "l_ains", "r_ains", "pcc", "acc", "pre_sma"))) %>%
  group_by(learner, roi, regressor) %>%
  summarise(mean_beta = mean(value),
            sem_beta = sem(value)) %>%
  # filter(roi %in% c("l_vstr","acc", "pre_sma")) %>%
  ggplot(aes(roi, mean_beta, col=learner))+
  geom_point(position=position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin=mean_beta-sem_beta, ymax=mean_beta+sem_beta), position = position_dodge(width=0.9), width=0.25)+
    geom_hline(aes(yintercept=0), linetype="dashed")+
  facet_grid(.~regressor)+
  xlab("")+
  ylab("Mean b")+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())
```

## M1-related activity

Increase of activity in response to M1 in all ROIs except vmPFC for both groups.
Decrease of activity in response to M1 for both groups.
Larger change for non-learners in all ROIs except vmPFC.

```{r}
all_roi_m1_betas %>%
 filter(abs(value) < 10) %>%
  left_join(learner_info %>% rename(sub_num=sub_id), by="sub_num") %>%
  mutate(learner=ifelse(learner == 1, "Learner", "Non-learner"),
         roi = factor(roi, levels = c("l_vstr", "r_vstr", "vmpfc", "l_ains", "r_ains", "pcc", "acc", "pre_sma"))) %>%
  group_by(learner, roi, regressor) %>%
  summarise(mean_beta = mean(value),
            sem_beta = sem(value)) %>%
  # filter(roi %in% c("l_vstr","acc", "pre_sma")) %>%
  ggplot(aes(roi, mean_beta, col=learner))+
  geom_point(position=position_dodge(width = 0.9))+
  geom_errorbar(aes(ymin=mean_beta-sem_beta, ymax=mean_beta+sem_beta), position = position_dodge(width=0.9), width=0.25)+
    geom_hline(aes(yintercept=0), linetype="dashed")+
  facet_grid(.~regressor)+
  xlab("")+
  ylab("Mean b")+
  theme(legend.title = element_blank(),
        panel.grid = element_blank())
```

## Brain-behavior correlation

Brain - parameter correlations? (Remember the question of interest is: what is the best/a good marker of self-regulation)

```{r}
source('/Users/zeynepenkavi/Dropbox/PoldrackLab/DevStudy_Analyses/code/workspace_scripts/rl_fits_data.R')
```

Is average PE related activity in any of the ROIs associated with the any model parameters?

```{r}
ave_roi_pe_betas = all_roi_pe_betas %>%
  filter(abs(value)<10)%>%
  group_by(roi, sub_num) %>%
  summarise(mean_b = mean(value))
```

Trying with one exp model first:

```{r}
ave_roi_pe_betas %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              filter(model == "Fit_alpha-beta-exp_neg-exp_pos_Fix_lossave_") %>%
              select(sub_id, learner, contains("xopt")) %>%
              select_if(~sum(!is.na(.)) > 0), by="sub_id") %>%
  gather(key, value, -learner, -roi, -sub_id, -mean_b) %>%
  mutate(learner = ifelse(learner == 1, "Learner", "Non-learner")) %>%
  ggplot(aes(value, mean_b, col=learner))+
  geom_point()+
  facet_grid(roi~key)+
  geom_abline(slope=1, intercept=0, linetype="dashed")+
  theme(panel.grid = element_blank(),
        legend.title = element_blank())+
  xlim(0,3)
```

```{r}
ave_roi_pe_betas %>%
  rename(sub_id = sub_num) %>% 
  left_join(best_sub_pars %>%
              select(sub_id, learner, model, contains("xopt")) %>%
              select_if(~sum(!is.na(.)) > 0), by="sub_id") %>%
  gather(key, value, -roi, -sub_id, -learner, -model, -mean_b)%>%
  group_by(model, roi, key) %>%
  summarise(roi_cor = cor(mean_b, value)) %>%
  mutate(t_val = (roi_cor*sqrt(72-2))/sqrt(1-roi_cor^2),
         p_val = pt(t_val, 70)*2) %>%
  drop_na()%>%
  mutate(p_val_adj = p.adjust(p_val), method="fdr") %>%
  arrange(-abs(roi_cor),p_val_adj)
```
